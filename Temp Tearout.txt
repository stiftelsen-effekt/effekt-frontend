logikk:


---
submit(state: string) fÃ¸r result:

var ResultPane = require('./result.js')

(...)

var resultPane = this.widget.panes.find(function (pane) { return pane instanceof ResultPane; })
        
if (state == "DONATION_RECIEVED") {
    resultPane.setResultState("DONATION_RECIEVED");
} else if (state == "BANK_PENDING") {
    resultPane.setResultState("BANK_PENDING");
} else if (state == "VIPPS_PENDING") {
    resultPane.setResultState("VIPPS_PENDING");
}

this.widget.nextSlide();
---

---
WEBSOCKETS

setupWebSocket() {
    this.socket = new WebSocket("wss://api.gieffektivt.no");
    var _self = this;
    
    this.socket.addEventListener("message", (msg) => { _self.onSocketMessage(msg); });
    this.socket.addEventListener("close", () => { console.log("Socket closed"); })
    this.socket.addEventListener("open", this.keepWebsocketAlive.bind(this));
}

keepWebsocketAlive() { 
    var timeout = 20000;
    if (this.socket.readyState == this.socket.OPEN) {  
        this.socket.send('');  
    }  
    this.websocketTimerId = setTimeout(this.keepWebsocketAlive.bind(this), timeout);  
}  
cancelWebsocketKeepAlive() {  
    if (this.websocketTimerId) {  
        clearTimeout(this.websocketTimerId);  
    }  
}

onSocketMessage(msg) {
    console.log("Socket message: ", msg);

    if (!this.clientWsID) {
        this.clientWsID = msg.data;
        this.updatePayPalForms();
    }
    else {
        if (msg.data == "PAYPAL_VERIFIED") {
            this.submit("DONATION_RECIEVED");
            this.cancelWebsocketKeepAlive();
            this.socket.close();
        }
        else if (msg.data == "PAYPAL_ERROR") {
            this.widget.error("Feil i PayPal");
            this.hideWaitingScreen();
        }
    }
}
---

---
PAYPAL PENDING:

showWaitingScreen() {
    this.paneElement.getElementsByClassName("awaiting-confirmation")[0].style.display = "flex";
}

hideWaitingScreen() {
    this.paneElement.getElementsByClassName("awaiting-confirmation")[0].style.display = "none";
}
---

---
PAYPAL BUTTONS:

payPalButtonHandler() {
    if (this.widget.recurring) {
        document.getElementById("submitRecurringPaypal").click();
    } else {
        document.getElementById('submitSinglePaypal').click();
    }
    this.showWaitingScreen();
}
---